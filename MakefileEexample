VPC_ID=
ACCESS_ROLE_ARM=
REGION=us-east-1
APP_NAME=gobid

ACCOUNT_ID=$(shell aws sts get-caller-identity --query Account --output text)
SG_NAME=$(APP_NAME)-sg
ECR_URL=$(ACCOUNT_ID).dkr.ecr.$(REGION).amazonaws.com
REPO_URL=$(ECR_URL)/$(APP_NAME)
DB_NAME=$(APP_NAME)-db
GO=$(shell which go)

create-sg:
	@if ! aws ec2 describe-security-groups --no-cli-pager --filters "Name=group-name, Values=$(SG_NAME)"  --region $(REGION) --query "SecurityGroups[*].GroupId" --output text | grep -qE 'sg-'; then \
		echo "Creating security group $(SG_NAME)..."; \
		aws ec2 create-security-group --no-cli-pager \
			--group-name $(SG_NAME) \
			--description "Allow Postgress for Gobid" \
			--vpc-id $(VPC_ID); \
	else \
		echo "Security group $(SG_NAME) already exists."; \
	fi;
	SG_ID=$$(aws ec2 describe-security-groups --no-cli-pager --filters "Name=group-name, Values=$(SG_NAME)"  --region $(REGION) --query "SecurityGroups[*].GroupId" --output text); \
	echo "Authorizing port 5432 on SG $$SG_ID..."; \
	aws ec2 authorize-security-group-ingress --no-cli-pager \
		--group-id $$SG_ID \
		--protocol tcp \
		--port 5432 \
		--cidr 0.0.0.0/0 \
		--region $(REGION) || echo "Ingress rule already exists or failed silenty."

create-ecr:
	@if aws ecr describe-repositories \
		--no-cli-pager \
		--repository-name $(APP_NAME) \
		--region $(REGION) \
		2> /dev/null; then \
		echo "Repository $(APP_NAME) already exists."; \
	else \
		echo "Repository $(APP_NAME) not found. Creating..."; \
		aws ecr create-repository \
			--repository-name $(APP_NAME) \
			--region $(REGION) \
			--no-cli-pager; \
	fi

build:
	docker build -t $(APP_NAME) -f Dockerfile.prod .

tag: build
	docker tag $(APP_NAME):latest $(REPO_URL):latest

push: tag
	aws ecr get-login-password --region $(REGION) | \
	docker login --username AWS --password-stdin $(ECR_URL)
	docker push $(REPO_URL):latest

create-db:
	@if ! aws rds describe-db-instances --no-cli-pager --db-instance-identifier $(DB_NAME) --region $(REGION) >/dev/null 2>&1; then \
		echo "Creating RDS isntance $(DB_NAME)..."; \
		SG_ID=$$(aws ec2 describe-security-groups --no-cli-pager --filters "Name=group-name, Values=$(SG_NAME)" --region $(REGION) --query "SecurityGroups[*].GroupId" --output text); \
		aws rds create-db-instance \
			--db-instance-identifier $(DB_NAME) \
			--db-instance-class db.t3.micro \
			--engine postgres \
			--allocated-storage 20 \
			--master-username postgres \
			--master-user-password 0123456789 \
			--vpc-security-group-ids $$SG_ID \
			--publicly-accessible \
			--backup-retention-period 0 \
			--no-multi-az \
			--engine-version 11.22-rds.20250814 \
			--port 5432 \
			--region $(REGION) \
			--no-cli-pager; \
	else \
		echo "RDS instance $(DB_NAME) already esists."; \
	fi

migrate:
	$(GO) run ./cmd/terndotenv/main.go

deploy:
	@if aws apprunner list-services --no-cli-pager --query "ServiceSummaryList[?ServiceName=='$(APP_NAME)']" --output text | grep -q '$(APP_NAME)'; then \
		echo "Service '$(APP_NAME)' already exists. Updating..."; \
		SERVICE_ARN=$$(aws apprunner list-services --no-cli-pager --query "ServiceSummaryList[?ServiceName=='$(APP_NAME)'].ServiceArn" --output text); \
		aws apprunner update-service \
			--no-cli-pager \
			--service-arn $$SERVICE_ARN \
			--source-configuration file://apprunner-config.json \
			--region $(REGION); \
	else \
		echo "Service '$(APP_NAME)' does not exist. Creating..."; \
		aws apprunner create-service \
		  --no-cli-pager \
			--service-name $(APP_NAME) \
			--source-configuration file://apprunner-config.json \
			--region $(REGION); \
	fi
